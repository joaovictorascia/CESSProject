<div class="max-w-md mx-auto mt-8">
  <h2 class="text-2xl font-bold text-center mb-6">Create Your Block+ Account</h2>

  <form id="register-form">
    <input type="hidden" id="wallet" name="wallet" value="">

    <div class="flex flex-col mb-4">
      <button type="button" id="connect-metamask-button" onclick="handleMetaMaskConnect()"
        class="bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600 transition-colors">
        Connect with MetaMask Account
      </button>
      <span id="metaBridge" class="text-sm text-gray-600 mt-1">Please wait until MetaMask bridge is established.</span>
    </div>

    <div class="flex flex-col mb-4">
      <label for="username" class="mb-2 font-medium">Username</label>
      <input type="text" id="username" name="username" required placeholder="Username (Must be Unique)"
        class="p-2 border rounded-sm focus:ring focus:ring-blue-300 focus:border-blue-500" oninput="validateForm()">
    </div>

    <div class="flex flex-col mb-4">
      <label for="password" class="mb-2 font-medium">Password</label>
      <input type="password" id="password" name="password" required placeholder="Create a strong password"
        class="p-2 border rounded-sm focus:ring focus:ring-blue-300 focus:border-blue-500" oninput="validateForm()">
    </div>

    <div class="flex items-start gap-2 text-sm mb-4">
      <input type="checkbox" id="terms" name="terms" required class="mt-1" onchange="validateForm()">
      <label for="terms" class="text-sm">
        I agree to the
        <a href="javascript:void(0)" hx-get="/pages/terms" hx-target="#content-area" hx-swap="innerHTML"
          preload="mouseover" class="text-blue-500 hover:underline">
          Terms
        </a>
        and
        <a href="javascript:void(0)" hx-get="/pages/privacy" hx-target="#content-area" hx-swap="innerHTML"
          preload="mouseover" class="text-blue-500 hover:underline">
          Privacy Policy
        </a>
      </label>
    </div>

    <button type="submit" id="register-submit-button"
      class="w-full bg-gray-400 text-white py-2 px-4 rounded cursor-not-allowed transition-colors"
      onclick="handleSubmit(event)" disabled>
      Create Account
    </button>
  </form>

  <div id="register-message"></div>
  <div id="register-indicator" class="htmx-indicator hidden">Processing...</div>
</div>

<script>
  let connectedWalletAddress = '';

  async function handleSubmit(event) {
    event.preventDefault();

    if (!validateForm()) {
      alert('Please fill all required fields and connect MetaMask');
      return;
    }

    const submitButton = document.getElementById('register-submit-button');
    const indicator = document.getElementById('register-indicator');
    const messageDiv = document.getElementById('register-message');

    // Show loading state
    submitButton.disabled = true;
    submitButton.textContent = 'Creating Account...';
    indicator.classList.remove('hidden');
    messageDiv.innerHTML = '';

    try {
      const formData = {
        wallet: document.getElementById('wallet').value,
        username: document.getElementById('username').value.trim(),
        password: document.getElementById('password').value
      };

      console.log('Sending form data:', formData);

      const response = await fetch('/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });

      const result = await response.json();

      if (response.ok) {
        // Store JWT token and wallet address in localStorage
        if (result.token && result.wallet) {
          localStorage.setItem('jwtToken', result.token);
          localStorage.setItem('walletAddress', result.wallet);
          console.log('JWT token and wallet address stored in localStorage');
          console.log('Token:', result.token);
          console.log('Wallet:', result.wallet);
        } else {
          console.warn('Missing token or wallet in response:', result);
        }

        messageDiv.innerHTML = `<div class="text-green-500 p-2 bg-green-50 rounded">Account created successfully! Redirecting...</div>`;

        // Hide indicator but keep button disabled during redirect
        if (indicator) {
          indicator.classList.add('hidden');
        }

        // Redirect to index page after successful registration
        setTimeout(() => {
          htmx.ajax('GET', '/', { target: 'body', swap: 'innerHTML' });
        }, 1500);

        return; // Exit early without resetting button
      } else {
        messageDiv.innerHTML = `<div class="text-red-500 p-2 bg-red-50 rounded">Error: ${result.message || 'Registration failed'}</div>`;
      }
    } catch (error) {
      console.error('Registration error:', error);
      messageDiv.innerHTML = `<div class="text-red-500 p-2 bg-red-50 rounded">Network error: ${error.message}</div>`;
    }

    // Only reset button state if registration failed
    resetRegisterButton();
  }

  function resetRegisterButton() {
    const submitButton = document.getElementById('register-submit-button');
    const indicator = document.getElementById('register-indicator');

    if (submitButton) {
      submitButton.disabled = false;
      submitButton.textContent = 'Create Account';
    }
    if (indicator) {
      indicator.classList.add('hidden');
    }
  }

  async function handleMetaMaskConnect() {
    const metaBridge = document.getElementById('metaBridge');
    const connectButton = document.getElementById('connect-metamask-button');
    const walletInput = document.getElementById('wallet');

    try {
      metaBridge.innerHTML = '<span class="text-blue-500">Connecting to MetaMask...</span>';
      connectButton.disabled = true;

      if (typeof window.ethereum === 'undefined') {
        throw new Error('MetaMask not installed');
      }

      const accounts = await window.ethereum.request({
        method: 'eth_requestAccounts'
      });

      if (accounts && accounts.length > 0) {
        const account = accounts[0];
        connectedWalletAddress = account;
        const shortenedAccount = account.substring(0, 6) + '...' + account.substring(account.length - 4);

        // Store in hidden field with correct name 'wallet'
        walletInput.value = account;

        metaBridge.innerHTML = `
        <span class="text-green-500">
          ✅ Connected: ${shortenedAccount}
        </span>
      `;
        connectButton.innerHTML = `Connected: ${shortenedAccount}`;
        connectButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
        connectButton.classList.add('bg-green-500');

        // Re-validate form after MetaMask connection
        validateForm();
      }

    } catch (error) {
      console.error('MetaMask connection error:', error);
      metaBridge.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
      connectButton.disabled = false;
    }
  }

  function validateForm() {
    const submitButton = document.getElementById('register-submit-button');
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const termsChecked = document.getElementById('terms').checked;

    // Check all conditions
    const isFormValid = connectedWalletAddress &&
      username.length >= 3 &&
      password.length >= 6 &&
      termsChecked;

    if (isFormValid) {
      // Enable button
      submitButton.disabled = false;
      submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
      submitButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'cursor-pointer');
    } else {
      // Disable button
      submitButton.disabled = true;
      submitButton.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'cursor-pointer');
      submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
    }

    return isFormValid;
  }

  // Utility functions for authentication
  function getToken() {
    return localStorage.getItem('jwtToken');
  }

  function getWalletAddress() {
    return localStorage.getItem('walletAddress');
  }

  function isLoggedIn() {
    const token = getToken();
    const wallet = getWalletAddress();

    if (!token || !wallet) return false;

    // Check if token is expired
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.exp > Date.now() / 1000;
    } catch (e) {
      return false;
    }
  }

  function logout() {
    localStorage.removeItem('jwtToken');
    localStorage.removeItem('walletAddress');
    htmx.ajax('GET', '/', { target: 'body', swap: 'innerHTML' });
  }

  function getAuthHeaders() {
    const token = getToken();
    return token ? {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    } : { 'Content-Type': 'application/json' };
  }

  function displayUserInfo() {
    const wallet = getWalletAddress();
    if (wallet) {
      const shortenedWallet = wallet.substring(0, 6) + '...' + wallet.substring(wallet.length - 4);

      // Update UI elements to show user is logged in
      const userInfoElement = document.getElementById('user-info');
      if (userInfoElement) {
        userInfoElement.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="text-sm">Connected: ${shortenedWallet}</span>
          <button onclick="logout()" class="text-sm text-red-500 hover:text-red-700">Logout</button>
        </div>
      `;
      }
    }
  }

  // Enhanced form submission handler
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('register-form');

    // Handle form submission
    form.addEventListener('submit', handleSubmit);

    // Check if user is already logged in
    if (isLoggedIn()) {
      const token = getToken();
      const wallet = getWalletAddress();
      console.log('User is already logged in:');
      console.log('Token:', token);
      console.log('Wallet:', wallet);

      // Update UI to show user info
      displayUserInfo();

      // If user is already logged in, maybe redirect to dashboard?
      // htmx.ajax('GET', '/dashboard', { target: 'body', swap: 'innerHTML' });
    }

    // Auto-connect check on page load
    if (typeof window.ethereum !== 'undefined') {
      window.ethereum.request({ method: 'eth_accounts' })
        .then(accounts => {
          if (accounts && accounts.length > 0) {
            const account = accounts[0];
            connectedWalletAddress = account;
            document.getElementById('wallet').value = account;

            const shortenedAccount = account.substring(0, 6) + '...' + account.substring(account.length - 4);
            document.getElementById('metaBridge').innerHTML = `
            <span class="text-green-500">
              ✅ Connected: ${shortenedAccount}
            </span>
          `;

            const connectButton = document.getElementById('connect-metamask-button');
            connectButton.innerHTML = `Connected: ${shortenedAccount}`;
            connectButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            connectButton.classList.add('bg-green-500');

            validateForm();
          }
        });
    }

    // Initial form validation
    validateForm();
  });

  // Optional: Real-time validation for better UX
  document.addEventListener('input', function (event) {
    if (event.target.matches('#username, #password')) {
      validateForm();
    }
  });

  document.addEventListener('change', function (event) {
    if (event.target.matches('#terms')) {
      validateForm();
    }
  });
</script>